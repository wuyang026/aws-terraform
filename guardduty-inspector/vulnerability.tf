# ------------------------------------------------------------
# GuardDuty Detector
# ------------------------------------------------------------

# GuardDuty Detector を新規作成
resource "aws_guardduty_detector" "this" {
  enable = true
}

# ------------------------------------------------------------
# GuardDuty の各種機能（Feature）をまとめて有効化
# ------------------------------------------------------------
resource "aws_guardduty_detector_feature" "all_features" {
  for_each = {
    s3_data            = "S3_DATA_EVENTS"
    eks_audit          = "EKS_AUDIT_LOGS"
    ebs_malware        = "EBS_MALWARE_PROTECTION"
    rds_login          = "RDS_LOGIN_EVENTS"
    lambda_network     = "LAMBDA_NETWORK_LOGS"
    runtime_monitoring = "RUNTIME_MONITORING"
  }

  # 上で統一した detector ID を参照
  detector_id = aws_guardduty_detector.this.id

  # 機能名
  name = each.value

  # 機能を有効化
  status = "ENABLED"

  # Runtime Monitoring の場合のみ追加設定を有効化する
  dynamic "additional_configuration" {
    for_each = each.value == "RUNTIME_MONITORING" ? [1] : []
    content {
      name   = "EKS_ADDON_MANAGEMENT"
      status = "ENABLED"
    }
  }
}

# ---------------------------------------------
# Inspector2 の有効化
# EC2 / ECR / Lambda の脆弱性スキャン
# ---------------------------------------------
resource "aws_inspector2_enabler" "this" {
  account_ids    = [data.aws_caller_identity.current.account_id]
  resource_types = ["EC2", "ECR", "LAMBDA"]
}

# ---------------------------------------------
# Security Hub CSPM（クラウドセキュリティ態勢管理） 
# ---------------------------------------------
resource "aws_securityhub_account" "this" {}
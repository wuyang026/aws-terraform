# GuardDuty 本体の有効化
# ガードデューティの検知エンジン（Detector）をオンにする
# ------------------------------------------------------------
resource "aws_guardduty_detector" "this" {
  enable = true
  depends_on = [aws_eks_addon.cloudwatch_observability]
}

# ------------------------------------------------------------
# GuardDuty の各種機能（Feature）をまとめて有効化
# for_each を使って複数機能を一括で ENABLED に設定
#
# 有効化する機能一覧:
# - S3_DATA_EVENTS           : S3 バケットのデータイベント監視
# - EKS_AUDIT_LOGS           : EKS の Audit Logs の監視
# - EBS_MALWARE_PROTECTION   : EBS ボリュームのマルウェアスキャン
# - RDS_LOGIN_EVENTS         : RDS へのログインイベント監視
# - LAMBDA_NETWORK_LOGS      : Lambda 関数のネットワーク動作監視
# - RUNTIME_MONITORING       : OS レベルのランタイム監視（EC2/ECS）
# ------------------------------------------------------------
resource "aws_guardduty_detector_feature" "all_features" {
  for_each = {
    s3_data            = "S3_DATA_EVENTS"
    eks_audit          = "EKS_AUDIT_LOGS"
    ebs_malware        = "EBS_MALWARE_PROTECTION"
    rds_login          = "RDS_LOGIN_EVENTS"
    lambda_network     = "LAMBDA_NETWORK_LOGS"
    runtime_monitoring = "RUNTIME_MONITORING"
  }

  detector_id = aws_guardduty_detector.this.id

  # 機能名
  name = each.value

  # 機能を有効化
  status = "ENABLED"

  dynamic "additional_configuration" {
    for_each = each.value == "RUNTIME_MONITORING" ? [1] : []
    content {
      name   = "EKS_ADDON_MANAGEMENT"
      status = "ENABLED"
    }
  }

  depends_on = [aws_guardduty_detector.this]
}

# ---------------------------------------------
# 現在の AWS アカウント ID を取得
# Inspector2 の有効化に必要
# ---------------------------------------------
data "aws_caller_identity" "current" {}

# ---------------------------------------------
# Inspector2 をアカウントに対して有効化
# EC2 / ECR / Lambda の脆弱性スキャンが対象
# ※ EKS は ECR イメージを経由して自動的にスキャンされる
# ---------------------------------------------
resource "aws_inspector2_enabler" "this" {
  account_ids    = [data.aws_caller_identity.current.account_id]
  resource_types = ["EC2", "ECR", "LAMBDA"]

  depends_on = [aws_eks_addon.cloudwatch_observability]
}